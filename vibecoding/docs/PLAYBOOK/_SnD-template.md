---
id: SnD-<YYYYMMDD>-<slug>
title: <機能名 / 変更名>
status: Draft
createdAt: <YYYY-MM-DD>
author: <your-name>
owners: [<team-or-person>]
tags: [<tag1>, <tag2>]
locale: <ja-JP|en-US|...>
quality_refresh_hash_at_created: "<StartAt> <hash>" # PRE-COMMON (`npm run -s check:pre-common`) が出力する1行をそのまま記録する
quality_refresh_hash_before_impl: "<StartAt> <hash>" # PRE-IMPL 直前に再実行した PRE-COMMON の出力を記録する
work_kind: "<feature|maintenance>" # 新規開発・機能追加なら feature、バグ修正や品質改修等は maintenance（未記載は maintenance 扱い）
context:
  Role: "Architect / Implementer / Reviewer"
  inputFiles: [<関連SPECや既存コード>]
  outputTargets: [<出力対象コード or ディレクトリ>]
---

# <機能名 / 変更名>

## 品質ゲート宣言（必読）
本SnDの実装（コード生成・編集）を行う際は、以下を単一情報源かつ必達目的として扱うこと：

- ゲート実行の参照設定（ESLint/tsconfig/policy 等）の SoT は `qualities/**`。
- コード生成時に参照する品質ゲートコンテキストの SoT は `vibecoding/var/contexts/qualities/**/context.md`（参照元は常に `qualities/**`）。`context.md` は人間可読な説明と、`### Quality Context Hash Manifest` セクション配下の YAML などの機械可読な情報を兼ね備えた「品質ゲートの地図」であり、コード生成/編集前に内容を把握しないと後続タスクの未達や品質低下、時間やトークンの浪費に直結する。特に事項の品質ゲート通過のネックとなる。また、テスト通過のためにも必要。必ず事前に全体の内容を把握すること。
- 実装は必ず `npm run check`（品質ゲート）を通過しなければならない。
- 品質ゲートに抵触する場合は、仕様を曖昧なまま実装しない。SnDを更新し、再承認を経て続行する。
- SnDはチャット履歴や非永続コンテキストに依存せず、後続モデルが単体で高精度実装できるだけの必要十分な情報を自己完結的に記述する。
- 用語注: 本SnDで言及する「対象」は実装対象を指し、品質コンテキストの適用対象（評価対象のコードパス）とは別概念である。`unit_path` は SPEC では定義せず、`vibecoding/var/contexts/qualities/**/context.*` に記述された値が最長一致規則で適用される（参照元は `qualities/**`）。hash manifest / unitDigest などの機械可読なシグネチャの SoT は、各ユニットの `context.md` 内 `### Quality Context Hash Manifest` セクション直下の YAML ブロックである。

---

## ステータス運用
- 状態: Draft → Ready → Reviewable → Implemented
  - Draft: PRE-COMMON の `<StartAt> <hash>` を SnD の front matter にまだ記録していない設計中の状態（IMPL フェーズへの承認フレーズはここでは出さない）。
  - Ready: PRE-COMMON 成功ハッシュを `quality_refresh_hash_at_created` に記録済みで、「未確定事項」が空の状態。Ready へ遷移した直後に、IMPL フェーズ移行用の承認フレーズ `PHASE=IMPL 承認: SnD=<path>`（または `PHASE=IMPL APPROVE: SnD=<path>`）をチャットやレビューコメントで必ず1回提示する。
  - Reviewable: IMPL 中の安定点で `npm run -s preflight` が成功した時点のレビュー合図。`npm run -s check:pre-impl` の標準出力1行を `quality_refresh_hash_before_impl` に記録し、本文に次の固定見出しを追記する（必須）: 「実装要約」「レビュワー向けコメント」「Preflight 結果」。
  - Implemented: `npm run check` を成功させ、SnD の「実施結果 / レビュワー向けコメント」を確定した状態。
- Ready 判定: 次を全て満たすこと
  - 「未確定事項」が空である
  - 必須セクション（背景/目的/非目標/設計構想/用語・境界/公開インタフェース/型設計/例外方針/受け入れ条件）が充足
  - 受け入れ条件が明文化され、テスト観点が列挙されている
- 逆トリガー: 「未確定事項」が再出現/追加された場合は Ready を取り消し、設計フェーズへ巻き戻す

---

## 改変許可範囲
- 対象範囲: この変更で手を入れてよいファイル / ディレクトリ
- 許可する変更: 具体的に許容する編集内容（例: リファクタ、命名、コメント整備）
- 禁止する変更: 影響が大きい、または今回の目的外の変更
- 影響範囲と注意: 既存機能や契約（API / 型）に与える影響、互換性ポリシー
- 期限 / 適用期間: この許可範囲が有効な期間やマイルストン
- 承認: 増減や逸脱を要する場合の承認者 / 手続き

---

## 実施方式 <!-- ADR執筆者向け注意: 本セクションは必ずそのまま残す。項目追加のみ可。本注意コメントは削除すること。 -->
本SnDの実施・実装は、プレイブックを単一の手順書として参照する：
 下記 (1)から(3)を一括バッチで実施する（省略不可）。
 (1) 設計前: [docs/PLAYBOOK/PRE-SnD.md]（共通: [docs/PLAYBOOK/PRE-COMMON.md]）を実施し、StartAt+hash を取得。作成時は `quality_refresh_hash_at_created` に記録。
 (2) 実装直前: [docs/PLAYBOOK/PRE-IMPL.md] に従い PRE-COMMON を再実行し、`quality_refresh_hash_before_impl` に記録。
 (3) 実装完了前: 結果記録・トラブルシューティング更新・コンテキストのバックフィルは [docs/PLAYBOOK/PRE-IMPL.md] の該当節を参照。
 - 設計フェーズの一時コードは `tmp/**` および `scripts/tmp/**` に限定し、PR に持ち込まない。取り込み時は本来のディレクトリへ移動し、サンドボックスは削除する。

<!-- POST-IMPL の具体手順はプレイブック [docs/PLAYBOOK/PRE-IMPL.md] を参照 -->
---

<!-- CONTEXT-BACKFILL の具体手順はプレイブック [docs/PLAYBOOK/PRE-IMPL.md] を参照 -->


## 背景 / 文脈
- 課題・背景・動機
- 関連する既存機能や制約

## 目的（Goals）
- 達成すべきこと（ユーザ価値・システム価値）

## 非目標（Non-Goals）
- 今回はやらないこと、将来に委ねること

## 設計構想（Design Concept）
- 本変更の設計思想・前提アーキテクチャ
- SOLID / Clean / Twin-Layer / DIP の観点での位置づけ
- 想定する拡張ポイント、依存解消戦略
- 目的に鑑み、防止すべき状況を10つ以上考え、セルフレビューし、現実的に発生しうる項目を「防止すべき状況」として対策とともに挙げる

## 用語 / 境界
- 責務境界（どこからどこまでをこの変更が担うか）
- 依存関係の明示（上流 / 下流、外部サービス、ストレージ等）

## 公開インタフェース
- リクエスト / レスポンス（型定義）
- エンドポイント / メソッド / イベント定義
- バリデーション / 制約 / エラーコード

## 型設計
- ドメイン型、ユニオン / 列挙、Never到達の扱い
- 可変・不可変、Null許容戦略、Exact optional property types 等

## 例外・エラー方針
- 例外を投げる場面、返却エラーの構造
- ログ / テレメトリ / 再送出の方針

## セキュリティ / パフォーマンス / 可観測性
- スレットモデル、権限、入力検証
- パフォーマンス予算、計測指標
- ログ、メトリクス、トレース

## 品質ゲート（このSnDの定義）
- 実行（npm）: `npm run check`
- 追加/上書きゲート（任意）: <例: e2e、Mutation、Bundle/Perf/Coverage 閾値 など>
- 測定指標/閾値（任意）: <例: p95 レイテンシ <= 30ms,  分岐網羅率 >= 80%>
- 例外運用（任意）: <一時免除時の承認者・期限>

## 受け入れ条件（Acceptance Criteria）

### 受け入れ条件（UI・UX）
- 見た目や操作感に関する「こうであれば受け入れる」条件（画面・CLI出力・APIレスポンスの人間視点）
- 例: 初期表示時に不要な成功メッセージが出ていないこと、主要操作に対するフィードバックが一定時間内に返ってくること

### 受け入れ不可条件（UI・UX）
- 意図に反する UI/UX を明示的に禁止する条件（「こうなっていたら NG」）。仕様のグレーゾーンをここで潰す
- 例: 初期表示からエラー/成功メッセージが常時表示されている、クリックしても 1 秒以上何も変化しない 等

### 受け入れ条件（UI・UX以外）
- 品質ゲートや非機能要求に関する条件（型安全性・ポリシー・セキュリティ・パフォーマンスなど）
- `npm run check` が成功すること（定義されたゲート全通過）
- 本SnDの「品質ゲート（このSnDの定義）」で定義した追加ゲート・閾値を満たすこと

### 受け入れ不可条件（UI・UX以外）
- システム的に許容できない状態を明示する条件（CORSエラーの恒常発生、型エラーを抑止コメントで隠す 等）
- 一時的な例外運用を行う場合は、「誰が・いつまで・どの条件で解消するか」をここに明記し、恒久化を避ける

## Quality Context Hash Manifest <!-- 品質系 SnD で必須。その他の SnD では任意。 -->
- 対象ユニット ID（例: `core/types/docs` 等）
- 参照した品質コンテキストの `context.md` パス（例: `vibecoding/var/contexts/qualities/docs/context.md` の `### Quality Context Hash Manifest` セクション）
- 各ユニットの unitDigest 値（`context.md` 内の YAML manifest に記録されたユニット全体の代表ハッシュ）

## マイグレーション / ロールアウト計画
- データ / API / 設定の移行手順
- フィーチャーフラグ（命名例: `migrate_<domain>_to_<target>`）

## 未確定事項
- 未決定の論点、判断者、期限

## リスク
- 想定されるリスクと影響
- 緩和策 / 監視方針
- ロールバック戦略

## AI実装指針 <!-- ADR執筆者向け注意: 本セクションは必ずそのまま残す。項目追加のみ可。本注意コメントは削除すること。 -->
- ソースコードのコメント（JSDoc/行コメント）は本SnDの `locale` に合わせて記述すること（混在禁止）。

## 実装時設計ログ（逐次追記）
実装中に確定した設計や判断を短く逐次で残す。後続の「実施結果」に集約する際の一次記録として用いる。

### Reviewable 更新（preflight 成功時の記録）
（IMPL 中の安定点で `npm run -s preflight` が成功したら、次を追記する）
- 実施時刻: <YYYY-MM-DDThh:mm:ssZ>
- quality_refresh_hash_before_impl: "<StartAt> <hash>"  # `npm run -s check:pre-impl` の出力をそのまま貼付

#### 実装要約（2-4行）
- 変更対象と要点:
- 影響範囲（パス/モジュール）:
- リスク/注意点（あれば）:

#### レビュワー向けコメント（観点の箇条書き）
- 型安全/複雑度/依存の見直しポイント:
- 例外・制御構造コメントの確認観点:
- テスト/確認観点（あれば）:

#### Preflight 結果サマリ（環境・観測）
- コマンド: npm run -s preflight
- 結果: 成功/失敗→修正→成功（要約）
- 補足: 代表的な修正（1-2件）

> 必須（Reviewable 遷移時）: 上記3項目（実装要約／レビュワー向けコメント／Preflight 結果）と `quality_refresh_hash_before_impl` の記録を欠かさないこと。

### テンプレート（コピーして使用）
- 記録時刻: <YYYY-MM-DDThh:mm:ssZ>
- 変更要約: <1-2行>
- 対象コードパス: <例: src/...>
- 関連SnD節: <例: 公開インタフェース / 型設計 など>
- 設計判断（Why/What/How）:
  - Why: <理由>
  - What: <決定内容>
  - How: <実装方針・具体策>
- 例外・エラー方針: <該当すれば>
- 影響範囲 / 非目標の変化: <該当すれば>
- テスト / 受け入れ条件の更新: <該当すれば>
- 参照品質コンテキスト: <vibecoding/var/contexts/qualities/.../context.md>
- 未確定事項: <残タスク・要判断>

### 記録
<!-- ここにエントリを時系列で追記 -->

## 実施結果 / レビュワー向けコメント
<!-- AGENT:RESULTS:START -->

### 実施概要
- **実装者**: <name>
- **実施日**: <YYYY-MM-DD>
- **検証結果**: ✅ `npm run check` 成功
- **要件充足確認**: <受け入れ条件を満たす旨を1行で記載>

### 全体概要
<この実装で達成したことを2-3行で説明>

### 作業ログ
- **実施コマンド**: `npm run check`
- **PRE-COMMON StartAt+hash**: `<YYYY-MM-DDThh:mm:ss.sssZ xxxxxxxxxx...>`
- **失敗→修正の経緯**: <ゲート失敗があった場合、何が失敗してどう修正したかを簡潔に>

### 実装詳細（ファイル別）

#### 追加ファイル
- **`<ファイルパス1>`**
  - 役割: <このファイルが担う責務>
  - 主要な実装内容: <主要な関数/クラス/型などを列挙>
  - 設計判断: <特記すべき設計判断があれば>

- **`<ファイルパス2>`**
  - 役割: <このファイルが担う責務>
  - 主要な実装内容: <主要な関数/クラス/型などを列挙>
  - 設計判断: <特記すべき設計判断があれば>

#### 更新ファイル
- **`<ファイルパス>`**
  - 変更内容: <何をどう変更したか>
  - 変更理由: <なぜこの変更が必要だったか>

#### 削除ファイル
- **`<ファイルパス>`**
  - 削除理由: <なぜ削除したか>

<!-- ファイル数が多い場合は適切にグループ化 -->
<!-- 例: -->
<!-- #### コアロジック (`src/game/core/**`) -->
<!-- #### UI層 (`src/game/ui/**`) -->
<!-- #### テストコード (`tests/game/**`) -->

### 品質・設計に関するコメント
- **型安全性**: <型チェックに関する特記事項>
- **複雑度**: <複雑な処理がある場合、その正当性>
- **テストカバレッジ**: <カバレッジの状況と未カバー部分の理由>
- **パフォーマンス**: <パフォーマンス考慮事項があれば>
- **セキュリティ**: <セキュリティ考慮事項があれば>
- **技術的負債**: <意図的な技術的負債があれば、その理由と解消計画>

### 設計上の判断・逸脱
- <SnDの設計から逸脱した点があれば記載（逸脱理由含む）>
- <代替案を検討したが採用しなかった理由>
- <将来的に見直しが必要な判断>

### リスク・制約事項
- <既知のリスクや制約があれば記載>
- <影響範囲と緩和策>

### フォローアップタスク
- [ ] <次に実施すべきタスク1>
- [ ] <次に実施すべきタスク2>

## トラブルシューティング・動作確認手順

本セクションは実装完了後の動作確認とトラブルシューティング手順を記載する。
**実装内容（Webアプリ/API/CLI/ライブラリ等）に応じて、設計者または実装者が具体的な手順を記述すること**。

### 動作確認手順
<!-- 実装内容に応じて具体的な手順を記述 -->

1. **起動方法**:
   ```bash
   # 起動コマンドを記載
   ```
2. **アクセス方法**: [URL / コマンド / 呼び出し方法を記載]
3. **確認項目**:
   - [ ] [具体的な動作確認1]
   - [ ] [具体的な動作確認2]
   - [ ] [エラーケースの確認]

### トラブルシューティング

#### Step 1: エラーメッセージの収集
<!-- 実装内容に応じて、エラー情報の収集方法を具体的に記述 -->
- [エラーログの確認場所]
- [収集すべき情報のリスト]

#### Step 2: 基本的な確認事項
- [ ] `npm install` は正常に完了したか？
- [ ] `npm run check` は成功しているか？
- [ ] [実装固有の確認項目を追記]

#### Step 3: AIへの報告フォーマット
問題を報告する際は、以下のテンプレートを使用：

```
【問題の概要】
[何をしようとしたか、何が起きたか を1-2行で]

【エラーメッセージ / ログ】
```
[出力をそのままペースト]
```

【再現手順】
1. [具体的な操作1]
2. [具体的な操作2]
3. [エラーが発生した操作]

【環境情報】
- OS: [例: Windows 11]
- Node.js: [例: v20.10.0]
- [その他の環境情報]

【すでに試したこと】
- [ ] npm install を再実行
- [ ] [その他試したこと]
```

### よくある問題（実装後に追記）
<!-- 実装完了後、実際に遭遇した問題をここに記録 -->
<!-- 問題が発生しなかった場合: "実装完了後、特記すべき問題は発生しませんでした。" と記載 -->

## 参考リンク
- 関連SPEC / ADR / Issue Tracker
